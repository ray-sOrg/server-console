# ========================================
# üîß Kubernetes ÈÉ®ÁΩ≤ÈÖçÁΩÆ
# ========================================
# È°πÁõÆÂêçÁß∞: server-console
# ÂÆπÂô®Á´ØÂè£: 5000
# ÂÅ•Â∫∑Ê£ÄÊü•: /health
# ========================================

apiVersion: apps/v1
kind: Deployment
metadata:
  name: server-console-deployment
  labels:
    app: server-console
spec:
  replicas: 2
  strategy:
    type: RollingUpdate
    rollingUpdate:
      maxUnavailable: 1
      maxSurge: 1
  selector:
    matchLabels:
      app: server-console
  template:
    metadata:
      labels:
        app: server-console
    spec:
      imagePullSecrets:
        - name: tencent-tcr-secret
      containers:
        - name: server-console
          image: __IMAGE_NAME__:__IMAGE_TAG__
          ports:
            - containerPort: 5000
          env:
            # Êï∞ÊçÆÂ∫ìÈÖçÁΩÆ
            - name: DB_USERNAME
              valueFrom:
                secretKeyRef:
                  name: server-console-secret
                  key: DB_USERNAME
            - name: DB_PASSWORD
              valueFrom:
                secretKeyRef:
                  name: server-console-secret
                  key: DB_PASSWORD
            - name: DB_HOST
              valueFrom:
                secretKeyRef:
                  name: server-console-secret
                  key: DB_HOST
            - name: DB_PORT
              valueFrom:
                secretKeyRef:
                  name: server-console-secret
                  key: DB_PORT
            - name: DB_NAME
              valueFrom:
                secretKeyRef:
                  name: server-console-secret
                  key: DB_NAME
            # JWT ÈÖçÁΩÆ
            - name: JWT_SECRET_KEY
              valueFrom:
                secretKeyRef:
                  name: server-console-secret
                  key: JWT_SECRET_KEY
            # OSS ÈÖçÁΩÆ
            - name: OSS_ACCESS_KEY_ID
              valueFrom:
                secretKeyRef:
                  name: server-console-secret
                  key: OSS_ACCESS_KEY_ID
            - name: OSS_ACCESS_KEY_SECRET
              valueFrom:
                secretKeyRef:
                  name: server-console-secret
                  key: OSS_ACCESS_KEY_SECRET
            - name: OSS_BUCKET_NAME
              valueFrom:
                secretKeyRef:
                  name: server-console-secret
                  key: OSS_BUCKET_NAME
            # Flask ÁéØÂ¢É
            - name: FLASK_ENV
              value: "production"
            # Gunicorn ÈÖçÁΩÆ
            - name: GUNICORN_WORKERS
              value: "4"
            - name: LOG_LEVEL
              value: "info"
          readinessProbe:
            httpGet:
              path: /health
              port: 5000
            initialDelaySeconds: 10
            periodSeconds: 5
            timeoutSeconds: 3
            successThreshold: 1
            failureThreshold: 3
          livenessProbe:
            httpGet:
              path: /health
              port: 5000
            initialDelaySeconds: 30
            periodSeconds: 10
            timeoutSeconds: 3
            successThreshold: 1
            failureThreshold: 3
          resources:
            requests:
              memory: "256Mi"
              cpu: "250m"
            limits:
              memory: "512Mi"
              cpu: "500m"
---
apiVersion: v1
kind: Service
metadata:
  name: server-console-service
spec:
  selector:
    app: server-console
  ports:
    - protocol: TCP
      port: 80
      targetPort: 5000
  type: ClusterIP
---
apiVersion: networking.k8s.io/v1
kind: Ingress
metadata:
  name: server-console-ingress
  namespace: default
  annotations:
    cert-manager.io/cluster-issuer: letsencrypt-prod
    nginx.ingress.kubernetes.io/ssl-redirect: "true"
    nginx.ingress.kubernetes.io/force-ssl-redirect: "true"
    nginx.ingress.kubernetes.io/proxy-body-size: "50m"
spec:
  tls:
    - hosts:
        # ‰øÆÊîπ‰∏∫‰Ω†ÁöÑÂüüÂêç
        - api.tt829.cn
      secretName: server-console-tls
  rules:
    # ‰øÆÊîπ‰∏∫‰Ω†ÁöÑÂüüÂêç
    - host: api.tt829.cn
      http:
        paths:
          - path: /
            pathType: Prefix
            backend:
              service:
                name: server-console-service
                port:
                  number: 80
