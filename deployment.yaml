# ========================================
# ğŸ”§ Kubernetes éƒ¨ç½²é…ç½®
# ========================================
# é¡¹ç›®åç§°: server-console
# å®¹å™¨ç«¯å£: 5000
# å¥åº·æ£€æŸ¥: /health
# æ•°æ®åº“: Supabase PostgreSQL
# ========================================

apiVersion: apps/v1
kind: Deployment
metadata:
  name: server-console-deployment
  labels:
    app: server-console
spec:
  replicas: 2
  strategy:
    type: RollingUpdate
    rollingUpdate:
      maxUnavailable: 1
      maxSurge: 1
  selector:
    matchLabels:
      app: server-console
  template:
    metadata:
      labels:
        app: server-console
    spec:
      imagePullSecrets:
        - name: tencent-tcr-secret
      containers:
        - name: server-console
          image: __IMAGE_NAME__:__IMAGE_TAG__
          imagePullPolicy: Always
          ports:
            - containerPort: 5000
          env:
            # Supabase æ•°æ®åº“é…ç½®
            - name: DATABASE_URL
              valueFrom:
                secretKeyRef:
                  name: server-console-secret
                  key: DATABASE_URL
            # JWT é…ç½®
            - name: JWT_SECRET_KEY
              valueFrom:
                secretKeyRef:
                  name: server-console-secret
                  key: JWT_SECRET_KEY
            # OSS é…ç½®
            - name: OSS_ACCESS_KEY_ID
              valueFrom:
                secretKeyRef:
                  name: server-console-secret
                  key: OSS_ACCESS_KEY_ID
            - name: OSS_ACCESS_KEY_SECRET
              valueFrom:
                secretKeyRef:
                  name: server-console-secret
                  key: OSS_ACCESS_KEY_SECRET
            - name: OSS_BUCKET_NAME
              valueFrom:
                secretKeyRef:
                  name: server-console-secret
                  key: OSS_BUCKET_NAME
            # Flask ç¯å¢ƒ
            - name: FLASK_ENV
              value: "production"
            # Gunicorn é…ç½®
            - name: GUNICORN_WORKERS
              value: "4"
            - name: LOG_LEVEL
              value: "info"
          readinessProbe:
            httpGet:
              path: /health
              port: 5000
            initialDelaySeconds: 10
            periodSeconds: 5
            timeoutSeconds: 3
            successThreshold: 1
            failureThreshold: 3
          livenessProbe:
            httpGet:
              path: /health
              port: 5000
            initialDelaySeconds: 30
            periodSeconds: 10
            timeoutSeconds: 3
            successThreshold: 1
            failureThreshold: 3
          resources:
            requests:
              memory: "256Mi"
              cpu: "250m"
            limits:
              memory: "512Mi"
              cpu: "500m"
---
apiVersion: v1
kind: Service
metadata:
  name: server-console-service
spec:
  selector:
    app: server-console
  ports:
    - protocol: TCP
      port: 80
      targetPort: 5000
  type: ClusterIP
---
apiVersion: networking.k8s.io/v1
kind: Ingress
metadata:
  name: server-console-ingress
  namespace: default
  annotations:
    cert-manager.io/cluster-issuer: letsencrypt-prod
    nginx.ingress.kubernetes.io/ssl-redirect: "true"
    nginx.ingress.kubernetes.io/force-ssl-redirect: "true"
    nginx.ingress.kubernetes.io/proxy-body-size: "50m"
spec:
  tls:
    - hosts:
        # ä¿®æ”¹ä¸ºä½ çš„åŸŸå
        - api.tt829.cn
      secretName: server-console-tls
  rules:
    # ä¿®æ”¹ä¸ºä½ çš„åŸŸå
    - host: api.tt829.cn
      http:
        paths:
          - path: /
            pathType: Prefix
            backend:
              service:
                name: server-console-service
                port:
                  number: 80
