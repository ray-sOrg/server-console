name: ğŸš€ Build & Deploy to Production

on:
  push:
    branches: [main]

# ========================================
# ğŸ”§ é¡¹ç›®é…ç½®å˜é‡
# ========================================
env:
  # é¡¹ç›®åŸºæœ¬ä¿¡æ¯
  PROJECT_NAME: server-console

  # è…¾è®¯äº‘å®¹å™¨é•œåƒæœåŠ¡ TCR é…ç½®
  TCR_REGISTRY: ccr.ccs.tencentyun.com
  TCR_NAMESPACE: ray321

  # Kubernetes é…ç½®
  K8S_NAMESPACE: default
  K8S_DEPLOYMENT_FILE: deployment.yaml

  # å¥åº·æ£€æŸ¥é…ç½®
  HEALTH_CHECK_PATH: /health
  CONTAINER_PORT: 5000

  # éƒ¨ç½²è¶…æ—¶æ—¶é—´ï¼ˆç§’ï¼‰
  ROLLOUT_TIMEOUT: 180

jobs:
  # =============================
  # 1ï¸âƒ£ æ„å»ºé•œåƒå¹¶æ¨é€åˆ°è…¾è®¯ TCR
  # =============================
  build:
    name: ğŸ› ï¸ Build & Push Docker Image
    runs-on: ubuntu-latest

    outputs:
      image: ${{ steps.meta.outputs.image }}
      tag: ${{ steps.meta.outputs.tag }}

    steps:
      # æ‹‰å–ä»“åº“ä»£ç 
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      # è®¾ç½® Docker Buildx
      - name: Set up Docker Buildx
        uses: docker/setup-buildx-action@v3

      # ç™»å½•è…¾è®¯äº‘å®¹å™¨é•œåƒæœåŠ¡ TCR
      - name: Login to Tencent Cloud Container Registry
        uses: docker/login-action@v3
        with:
          registry: ${{ env.TCR_REGISTRY }}
          username: ${{ secrets.TCR_USERNAME }}
          password: ${{ secrets.TCR_PASSWORD }}

      # ç”Ÿæˆé•œåƒæ ‡ç­¾
      - name: Generate image metadata
        id: meta
        run: |
          IMAGE_NAME=${{ env.TCR_REGISTRY }}/${{ env.TCR_NAMESPACE }}/${{ env.PROJECT_NAME }}
          IMAGE_TAG="build-${GITHUB_RUN_NUMBER}-$(git rev-parse --short HEAD)"

          echo "image=$IMAGE_NAME" >> $GITHUB_OUTPUT
          echo "tag=$IMAGE_TAG" >> $GITHUB_OUTPUT

          echo "ğŸ·ï¸  é•œåƒæ ‡ç­¾: $IMAGE_TAG"
          echo "ğŸ“¤ æ¨é€åœ°å€: $IMAGE_NAME:$IMAGE_TAG"

      # æ„å»ºå¹¶æ¨é€é•œåƒ
      - name: Build & Push Docker Image
        uses: docker/build-push-action@v5
        with:
          context: .
          push: true
          tags: ${{ steps.meta.outputs.image }}:${{ steps.meta.outputs.tag }}
          cache-from: type=gha
          cache-to: type=gha,mode=max
          platforms: linux/amd64

  # =============================
  # 2ï¸âƒ£ éƒ¨ç½²åˆ° Kubernetes é›†ç¾¤
  # =============================
  deploy:
    name: ğŸš€ Deploy to Kubernetes
    runs-on: ubuntu-latest
    needs: build
    environment: production

    steps:
      # æ‹‰å–ä»“åº“ä»£ç 
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      # å®‰è£… kubectl
      - name: Install kubectl
        run: |
          if ! command -v kubectl &> /dev/null; then
            echo "kubectl not found, installing..."
            curl -LO "https://dl.k8s.io/release/$(curl -L -s https://dl.k8s.io/release/stable.txt)/bin/linux/amd64/kubectl"
            chmod +x kubectl
            mv kubectl /usr/local/bin/
          else
            echo "kubectl is already installed"
          fi

      # é…ç½® K8s è®¿é—®
      - name: Configure cluster access
        env:
          KUBECONFIG_CONTENT: ${{ secrets.KUBECONFIG }}
        run: |
          mkdir -p $HOME/.kube
          echo "$KUBECONFIG_CONTENT" > $HOME/.kube/config
          chmod 600 $HOME/.kube/config
          echo "KUBECONFIG=$HOME/.kube/config" >> $GITHUB_ENV

          echo "ğŸ“ é›†ç¾¤ API åœ°å€ï¼š"
          kubectl config view --minify -o jsonpath='{.clusters[0].cluster.server}'
          echo ""

          echo "ğŸ” éªŒè¯é›†ç¾¤è¿æ¥..."
          kubectl cluster-info --request-timeout=10s
          echo "âœ… K8s é›†ç¾¤è¿æ¥æˆåŠŸ"

      # åŒæ­¥åº”ç”¨ Secrets åˆ° Kubernetes
      - name: Sync Application Secrets to Kubernetes
        run: |
          cat <<EOF_SECRET | kubectl apply -f -
          apiVersion: v1
          kind: Secret
          metadata:
            name: server-console-secret
            namespace: ${{ env.K8S_NAMESPACE }}
          type: Opaque
          stringData:
            DATABASE_URL: "${{ secrets.DATABASE_URL }}"
            JWT_SECRET_KEY: "${{ secrets.JWT_SECRET_KEY }}"
            OSS_ACCESS_KEY_ID: "${{ secrets.OSS_ACCESS_KEY_ID }}"
            OSS_ACCESS_KEY_SECRET: "${{ secrets.OSS_ACCESS_KEY_SECRET }}"
            OSS_BUCKET_NAME: "${{ secrets.OSS_BUCKET_NAME }}"
          EOF_SECRET
          echo "âœ… åº”ç”¨ Secrets å·²åŒæ­¥"

      # åˆ›å»ºè…¾è®¯äº‘ TCR é•œåƒæ‹‰å–å‡­è¯
      - name: Create Tencent TCR Pull Secret
        run: |
          kubectl delete secret tencent-tcr-secret -n ${{ env.K8S_NAMESPACE }} --ignore-not-found=true

          kubectl create secret docker-registry tencent-tcr-secret \
            --docker-server=${{ env.TCR_REGISTRY }} \
            --docker-username="${{ secrets.TCR_USERNAME }}" \
            --docker-password="${{ secrets.TCR_PASSWORD }}" \
            --namespace=${{ env.K8S_NAMESPACE }}

          echo "âœ… è…¾è®¯äº‘ TCR é•œåƒæ‹‰å–å‡­è¯å·²åˆ›å»º"

      # æ›¿æ¢é•œåƒå¹¶éƒ¨ç½²
      - name: Apply deployment
        run: |
          IMAGE=${{ needs.build.outputs.image }}
          TAG=${{ needs.build.outputs.tag }}

          sed -i "s|__IMAGE_NAME__|$IMAGE|g" ${{ env.K8S_DEPLOYMENT_FILE }}
          sed -i "s|__IMAGE_TAG__|$TAG|g" ${{ env.K8S_DEPLOYMENT_FILE }}

          echo "ğŸš€ éƒ¨ç½²ç‰ˆæœ¬: $IMAGE:$TAG"
          kubectl apply -f ${{ env.K8S_DEPLOYMENT_FILE }}

      # æ£€æŸ¥éƒ¨ç½²çŠ¶æ€å¹¶è‡ªåŠ¨å›æ»š
      - name: Verify rollout & rollback if failed
        run: |
          DEPLOY_NAME=${{ env.PROJECT_NAME }}-deployment
          set -e
          if kubectl rollout status deployment/$DEPLOY_NAME --timeout=${{ env.ROLLOUT_TIMEOUT }}s; then
            echo "âœ… éƒ¨ç½²æˆåŠŸ"
          else
            echo "âŒ éƒ¨ç½²å¤±è´¥ï¼Œå¼€å§‹å›æ»š..."
            kubectl rollout undo deployment/$DEPLOY_NAME
            echo "ğŸ©¹ å·²å›æ»šåˆ°ä¸Šä¸€ä¸ªç¨³å®šç‰ˆæœ¬"
            exit 1
          fi

      # éƒ¨ç½²å®Œæˆé€šçŸ¥
      - name: Notify Deployment Result
        if: always()
        run: |
          STATUS=${{ job.status }}
          IMAGE=${{ needs.build.outputs.image }}
          TAG=${{ needs.build.outputs.tag }}
          echo "ğŸ“¢ éƒ¨ç½²çŠ¶æ€: $STATUS"
          echo "ğŸ“¦ é•œåƒ: $IMAGE:$TAG"
